[tasks.build-versioned]
description = "Builds release and names with version"
script = [
    "echo Building for target: ${CARGO_MAKE_BUILD_TARGET:-host}",
    "cargo build --release",
    "mkdir -p bin",
    "if [ -z \"${CARGO_MAKE_BUILD_TARGET}\" ]; then target_triple=$(rustc -vV | awk '/^host: / {print $2}'); source_path=target/release/${CARGO_MAKE_CRATE_NAME}; else target_triple=${CARGO_MAKE_BUILD_TARGET}; source_path=target/${CARGO_MAKE_BUILD_TARGET}/release/${CARGO_MAKE_CRATE_NAME}; fi",
    "cp \"${source_path}\" \"bin/${CARGO_MAKE_CRATE_NAME}-${CARGO_MAKE_CRATE_VERSION}-${target_triple}\"",
]

[tasks.wasm-cargo-build]
description = "Builds the project for WASM"
command = "cargo"
args = ["build", "--release", "--target", "wasm32-unknown-unknown", "--no-default-features"]

[tasks.wasm-bindgen]
description = "Generates WASM bindings"
install_crate = { crate_name = "wasm-bindgen-cli", binary = "wasm-bindgen", test_arg = "--version" }
command = "wasm-bindgen"
args = [
    "target/wasm32-unknown-unknown/release/ugv.wasm",
    "--out-dir", "wasm",
    "--target", "web",
    "--no-typescript"
]
dependencies = ["wasm-cargo-build"]

[tasks.build-wasm]
description = "Builds the WASM project and bindings"
dependencies = ["wasm-bindgen"]

[tasks.check-windows]
description = "Checks cross-compilation preliminaries for UGV for Windows (x86_64-pc-windows-gnu)"
command = "bash"
args = [
  "-lc",
  '''
set -e

echo "Building UGV for Windows (x86_64)..."

if ! rustup target list --installed | grep -q "x86_64-pc-windows-gnu"; then
  echo "Installing Windows target..."
  rustup target add x86_64-pc-windows-gnu
fi

if ! command -v x86_64-w64-mingw32-gcc >/dev/null 2>&1; then
  echo
  echo "ERROR: mingw-w64 is not installed!"
  echo "Please install it first:"
  echo "  Ubuntu/Debian: sudo apt install mingw-w64"
  echo "  Fedora:        sudo dnf install mingw64-gcc"
  echo "  Arch:          sudo pacman -S mingw-w64-gcc"
  exit 1
fi
  '''
]

[tasks.build-windows]
description = "Cross-compiles UGV for Windows (x86_64-pc-windows-gnu)"
dependencies = ["check-windows"]
command = "cargo"
args = ["build", "--release", "--target", "x86_64-pc-windows-gnu"]

[tasks.serve]
description = "Serves the WASM project locally"
script = [
    "echo \"Starting server at http://localhost:8080\"",
    "cargo install miniserve",
    "miniserve wasm -p 8080"
]
